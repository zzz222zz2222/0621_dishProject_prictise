<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>商家菜品管理系统</title>
	<link rel="stylesheet" href="js/bootstrap/dist/css/bootstrap.min.css">
	<script src="js/jquery/dist/jquery.min.js"></script>
	<script src="js/bootstrap/dist/js/bootstrap.min.js"></script>
	<script src="js/my.js"></script>
</head>
<body>


<style>
	.table th, .table td {
		text-align: center;
		vertical-align: middle;
	}

	.alert {
		margin-bottom: 20px;
	}

	.ml-2 {
		margin-left: 0.5rem;
	}

	.dish-img {
		max-width: 80px;
		max-height: 80px;
		border-radius: 4px;
	}
</style>


<div class="container">
	<div class="row clearfix">
		<div class="col-md-12 column">
			<table class="table table-bordered table-hover">
				<thead class="thead-light">
				<tr>
					<!--						<th>菜品号</th>-->
					<th>菜名</th>
					<th>价格</th>
					<th>商家名</th>
					<th>类型</th>
					<th>图片</th>
					<th>操作</th>
				</tr>
				</thead>
				<tbody id="disDis">
				<!-- 菜品数据将在这里动态加载 -->
				</tbody>
			</table>
		</div>
	</div>
	
	<div>
		<input id="find" name="find" class="form-control" placeholder="搜索菜名">
		<button type="button" class="form-control" onclick="searchDish()">搜索</button>
	</div>
	<div>
		<div style="margin-top: 20px;"> <!-- 增加间距，避免被表格遮挡 -->
			<div class="row">
				<div class="col-md-12 text-center"> <!-- text-center 让按钮居中 -->
					<button type='button' class='btn btn-default' onclick="viewMore()">查看更多</button>
				</div>
			</div>
		</div>
	</div>
</div>

	<div class="row clearfix">
		<div class="col-md-12 column">
			<div id="alert-container">
				<div id="njzpc" class="alert alert-info">菜品管理系统</div>
			</div>
			<form role="form" method="post" id="dishForm" enctype="multipart/form-data">
				<input type="hidden" id="action" name="action" value="insert">
				<input type="hidden" id="oldName" name="oldName" value="-1">

				<div class="form-group">
					<label for="name">菜名</label>
					<input class="form-control" id="name" name="name"
						   placeholder="请输入菜名" required>
				</div>

				<div class="form-group">
					<label for="price">价格</label>
					<input type="number" step="0.01" class="form-control" id="price"
						   name="price" placeholder="请输入价格" min="0" required>
				</div>

				<div class="form-group">
					<label for="typeId">类型</label>
					<select class="form-control" id="typeId" name="typeId" required>
<!--						<option value="">&#45;&#45; 选择类型 &#45;&#45;</option>-->
						<!-- 类型选项将在这里动态加载 -->
					</select>
				</div>

				<div class="form-group">
					<label for="picture">菜品图片</label>
					<input type="file" class="form-control" id="picture" name="picture"/>
				</div>

				<button id="btnZpc" class="btn btn-primary" type="button" onclick="verifyInput()">增加</button>

			</form>
		</div>
	</div>
</div>

<script>


 // 加载菜品类型下拉列表
function loadCategories() {
    $.ajax({
        url: "api/category/",
        success: function(r) {
            console.log(r); // 调试用，打印返回数据
            var options = '<option value="">-- 选择类型 --</option>';
            for(var i = 0; i < r.length; i++) {
                options += "<option value='" + r[i].typeId + "'>" + r[i].typeName + "</option>";
            }
            $("#typeId").html(options);
        },
        error: function() {
            console.error("加载类型数据失败");
            $("#typeId").html('<option value="">加载类型失败</option>');
        }
    });
}

// 页面加载时调用
loadCategories();

var pageNo = 1;

 // 显示菜品列表  //todo	注意注意注意注意 图片文件名称改变了，后续都要改动
function displayDish() {
    $.ajax({
        url: "api/dish",
		data:{pageNo:pageNo,
			userType: "seller"},
		success: function(r) {
			console.log(r);
			var s= "";
			r.forEach(function(dish){
				s += `
           <tr did='tr${dish.name}'>
                        <td>${dish.name}</td>
                    <td>¥${dish.price}</td>
                    <td>${dish.restaurantName}</td>
					<td>${dish.typeName}</td>
                        <td><img src="upload/dish_${dish.id}_.png"width='50' height='50'></td>

                        <td>
                        <button type='button' class='btn bt-default'
                        onclick='editDish("${dish.name}", ${dish.price}, "${dish.typeId}")'>修改</button>

                        <button type='button' class='btn btn-default' onclick='deleteDish("${dish.name}")'>删除</button>
                        </td>
        </tr>

    `;             });
			// $("#disDis").html(s);
			$("#disDis").append(s);
		}
	});
}
    displayDish();

	function viewMore(){
		pageNo++;
		displayDish();
	}

// 删除菜品
// todo 暂时不做
function deleteDish(name) {
    if (confirm("确定删除吗？")) {
        $.ajax({
            type: "delete",
            url: "api/dish/delete?name="+name,
            data: {name: name},
            success: function(r) {
                console.log(r);
                if (r.indexOf("success") > -1) {

                    // 删除成功后刷新整个菜品列表
					$("#disDis").empty(); // 清空
					pageNo = 1; // 重置页码
					displayDish(); // 重新加载
                    $("#njzpc").html("删除成功");
                } else {
                    $("#njzpc").html("删除失败");
                }
            },
            error: function() {
                $("#njzpc").html("删除请求失败");
            }
        });
    }
}



function verifyInput() {
    // 获取表单值

    var name = $("#name").val();
    var price = $("#price").val();
    var typeId = $("#typeId").val();

    // 验证菜品名称
    if (name.trim() === "") {
        $("#njzpc").html("菜品名称不能为空");
        return ;
    }

    // 验证菜品价格
    if (!isNumStr(price) || parseFloat(price) <= 0 || parseFloat(price) > 9999) {
        $("#njzpc").html("无效的价格，范围：0.01-9999");
        return ;
    }

    // 验证商家名称
    if (name.trim() === "") {
        $("#njzpc").html("菜品名称不能为空");
        return ;
    }
    // 验证菜品类型
     if (typeId.trim() === "") {
        $("#njzpc").html("请选择菜品类型");
        return;
    }
    $("#njzpc").html("数据验证通过");

	var action = $("#action").val();
	var url = "api/dish/" + (action == "insert" ? "insert" : "update");
	var userType = "seller";
	var type = (action=="insert" ? "post" : "put");
	var formData = new FormData($('#dishForm')[0]);

formData.append("userType", userType); // 正确方式
formData.append("pageNo",pageNo );

console.log(formData);

	//	todo 函数执行完后，action会自动消除 后续需要注意的问题
	//  把url,type action 放在函数外 作为全局变量
	$.ajax({
		// type: action == "insert" ? "post" : "put",
		// url: "api/dish/"+action == "insert" ? "post" : "put",
		type:type,
		url:url,
		data: formData,
		processData: false,  // 必须设置为false
		contentType: false,  // 必须设置为false
		success: function(r) {
			console.log(r);
			if (r.indexOf("success") > -1) {
				$("#njzpc").html(action == "insert" ? "增加成功" : "修改成功");
				if (action == "update") {
					$("#btnZpc").html("增加");
					$("#action").val("insert");



					$("#disDis").empty(); // 清空
					pageNo = 1; // 重置页码
					displayDish(); // 重新加载
					return;
				}
				$("#disDis").empty(); // 清空
				pageNo = 1; // 重置页码
				displayDish();
			} else if (r.indexOf("exist") > -1) {
				$("#njzpc").html("菜品已经存在");
			} else {
				$("#njzpc").html(action == "insert" ? "增加失败" : "修改失败");
			}
		},
		// error(x):
		// 		console.log(x);
	});
    }

// 编辑菜品
function editDish(name, price,typeId) {
	console.log(name, price,typeId);
    // document.getElementById("did").value = did;
    document.getElementById("name").value = name;
    document.getElementById("price").value = price;
    document.getElementById("typeId").value = typeId;

    // 区分新增或更新
    document.getElementById("btnZpc").innerHTML = "修改";
    document.getElementById("action").value = "update";
    document.getElementById("oldName").value = name;

}

	function searchDish(){
		    pageNo = 1; // 重置页码
		$.ajax({
			// type:"post",
			url:"api/dish",
			data:{
				find:$("#find").val(),
				userType:"seller",
				pageNo:pageNo,
			},
			success: function(r) {
				console.log("后端返回的菜品数据：", r);
				var s= "";
				r.forEach(function(dish){
					s += `
           <tr did='tr${dish.name}'>
                        <td>${dish.name}</td>
                        <td>¥${dish.price}</td>
                        <td>${dish.restaurantName}</td>
                        <td>${dish.typeName}</td>
                        <td><img src='upload/dish_${dish.id}_.png'width='50' height='50'></td>
        	</tr>

    `;             });
				$("#disDis").empty(); // 清空历史数据
				$("#disDis").html(s);
			}
		});
	}

</script>
</body>
</html>

<!--<script>-->


<!--	var userType = sessionStorage.getItem("userType")-->
<!--	if (userType!="seller"){-->
<!--		//跳转。login-->
<!--		window.location.href="login.html";-->
<!--	}-->

<!--	var pageNo = 1;-->

<!--	function displayDish() {-->

<!--		$.ajax({-->
<!--			url: "api/dish", // 完整路径，避免相对路径问题-->
<!--			data: {-->
<!--				pageNo: pageNo,    // 传递当前页码-->
<!--			},-->
<!--			success: function(r) {-->
<!--				var s = "";-->
<!--				console.log(r)-->
<!--				r.forEach(function(dish) {-->
<!--					s += `-->
<!--                <tr did='tr${dish.name}' >-->
<!--                    <td>${dish.name}</td>-->
<!--                    <td>¥${dish.price}</td>-->
<!--                    <td>${dish.restaurantName}</td>-->
<!--					<td>${dish.typeName}</td>-->
<!--					<td><img src='upload/dish${dish.id}_.png' width='50' height='50' alt='${dish.name}图片'></td>-->
<!--                </tr>-->
<!--                `;-->
<!--				});-->
<!--				// $("#disDis").html(s);-->
<!--				$("#disDis").append(s);-->
<!--			},-->
<!--			error: function(xhr) {-->
<!--				alert("加载菜品失败，状态码：" + xhr.status);-->
<!--			}-->
<!--		});-->
<!--	}-->
<!--	displayDish()-->
<!--	// // 3. 页面加载时执行：先验证登录，再加载菜品-->
<!--	// $(function() { // 确保DOM加载完成后执行-->
<!--	//      // 加载当前商家的菜品-->
<!--	// });-->

<!--	function viewMore(){-->
<!--		pageNo++;-->
<!--		displayDish();-->
<!--	}-->


<!--	function searchDish(){-->
<!--		$.ajax({-->
<!--			// type:"post",-->
<!--			url:"api/dish",-->
<!--			data:{-->
<!--				find:$("#find").val(),-->
<!--				userType:"customer",-->
<!--				pageNo:pageNo,-->
<!--			},-->
<!--			success: function(r) {-->
<!--				console.log("后端返回的菜品数据：", r);-->
<!--				var s= "";-->
<!--				r.forEach(function(dish){-->
<!--					s += `-->
<!--           <tr did='tr${dish.name}'>-->
<!--                        <td>${dish.name}</td>-->
<!--                        <td>¥${dish.price}</td>-->
<!--                        <td>${dish.restaurantName}</td>-->
<!--                        <td>${dish.typeName}</td>-->
<!--                        <td><img src='upload/dish${dish.id}_.png'width='50' height='50'></td>-->
<!--        </tr>-->

<!--    `;             });-->
<!--				$("#disDis").html(s);-->
<!--			}-->
<!--		});-->
<!--	}-->

<!--</script>-->
<!--</body>-->
<!--</html>-->